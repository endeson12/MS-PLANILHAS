<script>
        // Elementos do DOM
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const columnNameInput = document.getElementById('columnName');
        const messageArea = document.getElementById('messageArea');
        const resultsArea = document.getElementById('resultsArea');
        const resultsHeader = document.getElementById('resultsHeader');
        const resultsBody = document.getElementById('resultsBody');
        const downloadButton = document.getElementById('downloadButton');
        const submitButton = document.getElementById('submitButton');
        const loader = document.getElementById('loader');

        let processedData = []; // Armazena os dados processados para download

        // Função para exibir mensagens
        function showMessage(message, type = 'info') {
            messageArea.innerHTML = `<div class="p-4 rounded-md ${
                type === 'error' ? 'bg-red-100 text-red-700' :
                type === 'success' ? 'bg-green-100 text-green-700' :
                'bg-blue-100 text-blue-700'
            }" role="alert">${message}</div>`;
        }

        // Função para limpar mensagens e resultados
        function clearPreviousState() {
            messageArea.innerHTML = '';
            resultsArea.classList.add('hidden');
            resultsHeader.innerHTML = '';
            resultsBody.innerHTML = '';
            processedData = [];
            loader.style.display = 'none';
            submitButton.disabled = false;
        }

        // Função para processar o arquivo Excel
        async function handleFile(file, priceColumnName) {
            clearPreviousState();
            loader.style.display = 'block'; // Mostra o loader
            submitButton.disabled = true; // Desabilita o botão durante o processamento

            if (!file) {
                showMessage('Por favor, selecione um arquivo Excel.', 'error');
                loader.style.display = 'none';
                submitButton.disabled = false;
                return;
            }

            if (!priceColumnName) {
                showMessage('Por favor, informe o nome da coluna de preços.', 'error');
                loader.style.display = 'none';
                submitButton.disabled = false;
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length === 0) {
                        throw new Error("A planilha está vazia.");
                    }

                    const headers = jsonData[0].map(h => String(h).trim());
                    const priceColumnIndex = headers.findIndex(header => header.toLowerCase() === priceColumnName.trim().toLowerCase());

                    if (priceColumnIndex === -1) {
                        // CORREÇÃO 1: Usado crase (`) para permitir a interpolação da variável ${priceColumnName}
                        throw new Error(`A coluna "${priceColumnName}" não foi encontrada. Verifique o nome. Cabeçalhos encontrados: ${headers.join(', ')}`);
                    }

                    processedData = [];
                    // CORREÇÃO 2: Usado crase (`) no nome da nova coluna para que ${priceColumnName} funcione.
                    const newHeaders = [...headers, 'Desconto Aplicado (%)', `Preço Final`];
                    processedData.push(newHeaders);

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const originalPrice = row[priceColumnIndex];
                        let discountPercent = null;
                        let finalPrice = null;

                        // MELHORIA: Trata valores de moeda (ex: "R$ 1.234,56") antes de converter para número
                        let price = NaN;
                        if (typeof originalPrice === 'string') {
                             price = parseFloat(originalPrice.replace(/[^0-9,-]+/g,"").replace(',', '.'));
                        } else {
                             price = parseFloat(originalPrice);
                        }


                        if (!isNaN(price) && price > 0) {
                            const discountFactor = Math.random() * (0.50 - 0.30) + 0.30;
                            discountPercent = (discountFactor * 100);
                            finalPrice = (price * (1 - discountFactor));
                        } else {
                            finalPrice = originalPrice;
                            discountPercent = '';
                        }
                        
                        const processedRow = [...row];
                        while (processedRow.length < headers.length) {
                            processedRow.push('');
                        }
                        processedRow.push(discountPercent);
                        processedRow.push(finalPrice);
                        processedData.push(processedRow);
                    }

                    displayResults(processedData, priceColumnIndex);
                    showMessage('Arquivo processado com sucesso!', 'success');
                    resultsArea.classList.remove('hidden');

                } catch (error) {
                    console.error("Erro ao processar o arquivo:", error);
                    // CORREÇÃO 3: Usado crase (`) para exibir a mensagem de erro real.
                    showMessage(`Erro ao processar o arquivo: ${error.message}`, 'error');
                } finally {
                    loader.style.display = 'none';
                    submitButton.disabled = false;
                }
            };

            reader.onerror = function() {
                showMessage('Erro ao ler o arquivo.', 'error');
                loader.style.display = 'none';
                submitButton.disabled = false;
            };

            reader.readAsArrayBuffer(file);
        }

        // Função para exibir os resultados na tabela
        function displayResults(data, originalPriceColumnIndex) {
            resultsHeader.innerHTML = '';
            resultsBody.innerHTML = '';

            if (data.length === 0) return;

            const headerRow = document.createElement('tr');
            data[0].forEach(headerText => {
                const th = document.createElement('th');
                th.scope = "col";
                th.className = "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            resultsHeader.appendChild(headerRow);

            for (let i = 1; i < data.length; i++) {
                const dataRow = document.createElement('tr');
                data[i].forEach((cellData, index) => {
                    const td = document.createElement('td');
                    td.className = "px-3 py-4 whitespace-nowrap text-sm text-gray-700";
                    
                    const isDiscountColumn = index === data[0].length - 2;
                    const isFinalPriceColumn = index === data[0].length - 1;
                    const isOriginalPriceColumn = index === originalPriceColumnIndex;

                    if ((isFinalPriceColumn || isOriginalPriceColumn) && typeof cellData === 'number') {
                        td.textContent = cellData.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    } else if (isDiscountColumn && typeof cellData === 'number') {
                        // CORREÇÃO 4: Usado crase (`) para formatar a porcentagem corretamente.
                        td.textContent = `${cellData.toFixed(2).replace('.', ',')}%`;
                    } else {
                        td.textContent = cellData === null || cellData === undefined ? '' : cellData;
                    }
                    dataRow.appendChild(td);
                });
                resultsBody.appendChild(dataRow);
            }
        }

        // Função para gerar e baixar o arquivo Excel com os resultados
        function downloadResults() {
            if (processedData.length === 0) {
                showMessage('Não há dados processados para baixar.', 'error');
                return;
            }
            try {
                // Converte os dados para o formato numérico correto no Excel
                const dataForExport = processedData.map((row, rowIndex) => {
                    if (rowIndex === 0) return row; // Mantém o cabeçalho como está
                    return row.map((cell, cellIndex) => {
                        // Converte colunas de preço e desconto para o tipo número
                        const isDiscountColumn = cellIndex === processedData[0].length - 2;
                        if (isDiscountColumn && typeof cell === 'number') return cell / 100; // Salva desconto como 0.35
                        if (typeof cell === 'number') return cell;
                        return cell;
                    });
                });

                const ws = XLSX.utils.aoa_to_sheet(dataForExport);

                // Aplica formatação de moeda e porcentagem nas colunas
                const priceColumnIndex = processedData[0].findIndex(h => h.toLowerCase() === columnNameInput.value.trim().toLowerCase());
                if(ws['!cols'] == null) ws['!cols'] = [];
                
                // Formatação da coluna de preço original
                 if(priceColumnIndex > -1) {
                    ws['!cols'][priceColumnIndex] = { wch: 15 }; // Largura da coluna
                    Object.keys(ws).forEach(cell => {
                        if (cell[0] === XLSX.utils.encode_col(priceColumnIndex) && cell.substring(1) > 1) {
                            ws[cell].z = 'R$ #,##0.00'; // Formato de moeda
                        }
                    });
                 }
                // Formatação da coluna de preço final
                const finalPriceCol = processedData[0].length - 1;
                 ws['!cols'][finalPriceCol] = { wch: 15 };
                 Object.keys(ws).forEach(cell => {
                        if (cell[0] === XLSX.utils.encode_col(finalPriceCol) && cell.substring(1) > 1) {
                            ws[cell].z = 'R$ #,##0.00';
                        }
                    });

                // Formatação da coluna de desconto
                const discountCol = processedData[0].length - 2;
                ws['!cols'][discountCol] = { wch: 15 };
                 Object.keys(ws).forEach(cell => {
                        if (cell[0] === XLSX.utils.encode_col(discountCol) && cell.substring(1) > 1) {
                            ws[cell].z = '0.00%'; // Formato de porcentagem
                        }
                    });


                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Resultados com Desconto');

                const originalFilename = fileInput.files[0].name;
                const baseName = originalFilename.substring(0, originalFilename.lastIndexOf('.')) || originalFilename;
                // CORREÇÃO 5: Usado crase (`) para montar o nome do arquivo.
                const downloadFilename = `${baseName}_com_desconto.xlsx`;

                XLSX.writeFile(wb, downloadFilename);
                showMessage('Arquivo Excel gerado para download.', 'success');
            } catch (error) {
                console.error("Erro ao gerar o arquivo Excel:", error);
                showMessage(`Erro ao gerar o arquivo Excel: ${error.message}`, 'error');
            }
        }

        // Event Listener para o envio do formulário
        uploadForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const file = fileInput.files[0];
            const columnName = columnNameInput.value;
            handleFile(file, columnName);
        });

        // Event Listener para o botão de download
        downloadButton.addEventListener('click', downloadResults);
    </script>
